# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: JimSql build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'\n        cache: maven
#        cache: maven
        server-id: ossrh
        server-username: ${{ secrets.MAVEN_USERNAME }}
        server-password: ${{ secrets.MAVEN_PASSWORD }}

    - name: Build with Maven
      run: mvn -B package -DskipTests=true  --file pom.xml


    - name: Publish package
      run: mvn --batch-mode deploy
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
#    - name: Release Maven package
#      uses: samuelmeuli/action-maven-publish@v1
#      with:
#        gpg_private_key: ${{ secrets.GPG_SECRET }}
#        gpg_passphrase: ${{ secrets.GPG_PASSWORD  }}
#        nexus_username: ${{ secrets.NEXUS_USERNAME }}
#        nexus_password: ${{ secrets.NEXUS_USERNAME }}

#    - name: Checkout code
#      uses: actions/checkout@v2

      # setup Docker buld action
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOUSER }}
        password: ${{ secrets.DOHUB }}

#      - name: Login to Github Packages
#        uses: docker/login-action@v1
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GHCR_PAT }}

    - name: Build image and push to Docker Hub and GitHub Container Registry\n      if: github.ref == 'refs/heads/master' && github.event_name == 'push'\n      uses: docker/build-push-action@v2\n      with:\n        context: server\n        tags: dafei1288/jimsql_server:latest\n        push: true

    - name: Image digest
      run: echo ${{ steps.docker_build.outputs.digest }}
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven
      - name: Build server and cli
        run: |
          mvn -q -pl server -am package -DskipTests
          mvn -q -pl cli -am package -DskipTests
      - name: Start legacy server
        run: |
          nohup java -jar server/target/*-jar-with-dependencies.jar 8821 127.0.0.1 server/src/main/resources/datadir >/tmp/server.log 2>&1 & echo $! > /tmp/server.pid
          for i in {1..50}; do (echo > /dev/tcp/127.0.0.1/8821) >/dev/null 2>&1 && break; sleep 0.2; done
      - name: Legacy smoke (SHOW TABLES)
        run: |
          java -jar cli/target/*.jar --url "jdbc:jimsql://127.0.0.1:8821/test?protocol=legacy" --command "show tables;" | tee /tmp/out.txt
          grep -i "Rows:" /tmp/out.txt
      - name: Stop legacy server
        run: |
          kill $(cat /tmp/server.pid) || true
          sleep 1
      - name: Start jspv1 server
        run: |
          nohup java -jar server/target/*-jar-with-dependencies.jar 8821 127.0.0.1 server/src/main/resources/datadir jspv1 >/tmp/server2.log 2>&1 & echo $! > /tmp/server2.pid
          for i in {1..50}; do (echo > /dev/tcp/127.0.0.1/8821) >/dev/null 2>&1 && break; sleep 0.2; done
      - name: JSPv1 smoke (SHOW DATABASES)
        run: |
          java -jar cli/target/*.jar --url "jdbc:jimsql://127.0.0.1:8821/test?protocol=jspv1" --command "show databases;" | tee /tmp/out2.txt
          grep -i "Rows:" /tmp/out2.txt
      - name: Stop jspv1 server
        run: |
          kill $(cat /tmp/server2.pid) || true
  itests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven
      - name: Build server and jdbc
        run: |
          mvn -q -pl server -am package -DskipTests
          mvn -q -pl jdbc -am -DskipTests package
      - name: Start legacy server
        run: |
          nohup java -jar server/target/*-jar-with-dependencies.jar 8821 127.0.0.1 server/src/main/resources/datadir >/tmp/server.log 2>&1 & echo $! > /tmp/server.pid
          for i in {1..50}; do (echo > /dev/tcp/127.0.0.1/8821) >/dev/null 2>&1 && break; sleep 0.2; done
      - name: Run legacy JDBC tests
        run: mvn -q -pl jdbc -am -DskipTests=false -Dtest=LegacyDmlUpdateCountTest test
      - name: Stop legacy server
        run: |
          kill $(cat /tmp/server.pid) || true
          sleep 1
      - name: Start jspv1 server
        run: |
          nohup java -jar server/target/*-jar-with-dependencies.jar 8821 127.0.0.1 server/src/main/resources/datadir jspv1 >/tmp/server2.log 2>&1 & echo $! > /tmp/server2.pid
          for i in {1..50}; do (echo > /dev/tcp/127.0.0.1/8821) >/dev/null 2>&1 && break; sleep 0.2; done
      - name: Run jspv1 JDBC tests
        run: mvn -q -pl jdbc -am -DskipTests=false -Dtest=JspV1DmlUpdateCountTest,JspV1ErrorMappingTest test
      - name: Stop jspv1 server
        run: |
          kill $(cat /tmp/server2.pid) || true
  eol-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enforce LF endings in sources
        run: |
          set -euo pipefail
          files=$(git ls-files \
            '*.java' '*.g4' '*.xml' '*.md' '*.yml' '*.yaml' '*.sh' '*.sql' '*.properties' || true)
          if [ -n "$files" ]; then
            bad=$(echo "$files" | xargs -r grep -n $'\r' -I || true)
            if [ -n "$bad" ]; then
              echo "Carriage returns found in source files:" >&2
              echo "$bad" >&2
              exit 1
            fi
          fi